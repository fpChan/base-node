#!/bin/bash
set -eu

VERBOSITY=${GETH_VERBOSITY:-3}
GETH_DATA_DIR=/data
RPC_PORT="${RPC_PORT:-8545}"
WS_PORT="${WS_PORT:-8546}"
AUTHRPC_PORT="${AUTHRPC_PORT:-8551}"
METRICS_PORT="${METRICS_PORT:-6060}"
#HOST_IP="" # put your external IP address here and open port 30303 to improve peer connectivity
P2P_PORT="${P2P_PORT:-30303}"
ADDITIONAL_ARGS=""
OP_GETH_GCMODE="${OP_GETH_GCMODE:-full}"
OP_GETH_SYNCMODE="${OP_GETH_SYNCMODE:-full}"

if [[ -z "$OP_NODE_NETWORK" ]]; then
    echo "expected OP_NODE_NETWORK to be set" 1>&2
    exit 1
fi

mkdir -p $GETH_DATA_DIR

echo "$OP_NODE_L2_ENGINE_AUTH_RAW" > "$OP_NODE_L2_ENGINE_AUTH"

if [ "${OP_GETH_ETH_STATS+x}" = x ]; then
    ADDITIONAL_ARGS="$ADDITIONAL_ARGS --ethstats=$OP_GETH_ETH_STATS"
fi

if [ "${OP_GETH_ALLOW_UNPROTECTED_TXS+x}" = x ]; then
    ADDITIONAL_ARGS="$ADDITIONAL_ARGS --rpc.allow-unprotected-txs=$OP_GETH_ALLOW_UNPROTECTED_TXS"
fi

if [ "${OP_GETH_STATE_SCHEME+x}" = x ]; then
    ADDITIONAL_ARGS="$ADDITIONAL_ARGS --state.scheme=$OP_GETH_STATE_SCHEME"
fi

if [ "${OP_GETH_BOOTNODES+x}" = x ]; then
    ADDITIONAL_ARGS="$ADDITIONAL_ARGS --bootnodes=$OP_GETH_BOOTNODES"
fi

#if [ "${HOST_IP:+x}" = x ]; then
#	ADDITIONAL_ARGS="$ADDITIONAL_ARGS --nat=extip:$HOST_IP"
#fi

exec ./geth \
    --datadir="$GETH_DATA_DIR" \
    --verbosity="$VERBOSITY" \
    --db.engine=pebble \
    --state.scheme=path \
    --history.transactions=23500 \
    --history.state=900 \
    --cache=4096 \
    --http \
    --http.corsdomain="*" \
    --http.vhosts="*" \
    --http.addr=0.0.0.0 \
    --http.port="$RPC_PORT" \
    --http.api=web3,debug,eth,txpool,net,engine \
    --authrpc.addr=0.0.0.0 \
    --authrpc.port="$AUTHRPC_PORT" \
    --authrpc.vhosts="*" \
    --authrpc.jwtsecret="$OP_NODE_L2_ENGINE_AUTH" \
    --ws \
    --ws.addr=0.0.0.0 \
    --ws.port="$WS_PORT" \
    --ws.origins="*" \
    --ws.api=debug,eth,txpool,net,engine \
    --metrics \
    --metrics.addr=0.0.0.0 \
    --metrics.port="$METRICS_PORT" \
    --syncmode="$OP_GETH_SYNCMODE" \
    --gcmode="$OP_GETH_GCMODE" \
    --maxpeers=100 \
    --rollup.sequencerhttp="$OP_GETH_SEQUENCER_HTTP" \
    --rollup.halt=major \
    --op-network="$OP_NODE_NETWORK" \
    --port="$P2P_PORT" \
    --bootnodes "enode://e5a61ec4be3d8383dd9932523a323e5e100f271958c6c0d416d96ec035fd41314834e9dbfa125e7ba13289af9de5eff2d79271e1120e3df47a0deece5f170b5a@130.61.106.250:30303,enode://2f0ca0ceb8b547696d23e9dbe058095563bd4d7f7cc4c5e98e5c7c07a791e87d59daea983ef7ce1b9e65709d187e0126d38ddd91256ab67801c827be863c34db@95.217.120.236:30303,enode://0485069ac65159e4b0d7fb8fbf53c9b71ce28bd2e07615ffb6764e9c761760c971f0577409c8a0e126b37be21b0673e496a85e9a1b88b3e935abb777650264f8@50.18.87.49:30303,enode://5e74f9b187dc0ce2d242a212252a4f22360c2cc6cb4c7911b09756d7b7e0a092773d580d216a7f0c8cbbb35631a04635d862595c61997f407bee7b3f7f0b3b39@15.204.222.130:30303,enode://9c40cff572d14caa2ccfa1c37fdcb2e2019b54e9cfec8fb17dcaadf8665158c64bd419204f1bbc2fde0313bbeb9bafd24a86f70659f284f012b2236ecfe9347d@162.220.162.182:40303,enode://37c5fa88197b38890f2d50f45b29c6d55fa68ab2edd08020dbc7d4d52887bc375418074946fd8cd70534220d32ca4dca7e6b19d0108d5fbbdd70bda017528765@34.32.238.165:30303?discport=30301,enode://17ea82762203ba12d25d3fc3a23895838aa1d9bde006ce43d0cabf5759c6ef2812ec6565070b8fc2cc9f8833b09eb82f8bea6c69017273d0f475abba69aca575@54.153.65.222:30303,enode://7471b355f0cff27341c0c5f9100950612b4bf8cf48f50758bc3eb35778bf2f8a94c6ae52feaa3d765c643448a944f9f3075c711fff0f8657123cb95bfb011bfd@138.2.91.177:30303?discport=9000,enode://7240226909f90f292c47383daaca4b517ced5e05753f0b9aca847804f5dd51e874596c9693ac5c2f0c524d6c0db45cc7f60fdff7d1dea95634dea9be373dcc84@65.108.131.176:30304?discport=9999,enode://4ef9300219935d1ed766073300541ad925eca9e01177f0d21fd9265103b8bf90bf976884df19d8df0b667b889de16751c163f4aa3db1e1f441ac9bfac6335ce7@67.209.55.23:13503,enode://e04c319e4713149d8f9bc0741b3ab8f4b1ef076c06938bfbfb328adc61d35fd6e59598a3d699e9e65b338b45f4f91bc836a8183cb522af489e06f713f8e12887@162.55.14.47:40303,enode://5e74f9b187dc0ce2d242a212252a4f22360c2cc6cb4c7911b09756d7b7e0a092773d580d216a7f0c8cbbb35631a04635d862595c61997f407bee7b3f7f0b3b39@15.204.222.129:30303,enode://ce6186adc63983acc9557755fe73eaa18e5eaed68ebe13972a9acf1ece166d2eb3b5c72af5411ea04a0b825e50939dc571c603e4301a08f6ccb289fde36257ff@18.195.171.175:30304?discport=30303,enode://c144953c63fc1325c0c84b1b90489dc2640e26acc6863fdaa5b0ca5898877e874e51e5df8e2921b08a8c095b7283213f72178bf8a79be254e5fc67e98d31fd70@117.27.228.173:31003,enode://3cfe0d21fc672374371d295897b0747f6706c02b7131f2513c8deb0c27623fa8dce9c238d760dc7b43d259aa906fb2e5da9f6841be801ee263da0197ca7b4c72@141.148.66.135:30303,enode://aa6b93472ce23df69128b8459ab6007c449a518f32870028a0d47c0f6a430a808363036c1bd2cb142a5868a2a8e1ddbd0a24896d6d6cceab9267fd8449aa65a5@65.21.65.246:30303,enode://6cc99f4e5bf3b7261f909d34bb7d0f08f247f7b5f8958ad3aed636f9f3fc43c29b5e12c57068b9f3fe57b8004c6c89deef496fd829b5b28b4956cb2752a8e3a8@162.55.75.187:30303,enode://14d0dbb9608d60e751cf83ad57085f5dfc3556de58ee2aee7f5092ff164a9b5f90bf8be3f87ff250a06ace7e5ff6268c51ea5e4cc563e794fe53987997e41722@173.231.41.130:30306,enode://fa27da5e515ee07ec6a4170d986ad68aa212d4bf129ddfdfce3da521500ace7e9b9bdde939ec9431405f6a20a3354722e860675224f36a555a865a9bfc0af4bc@204.16.247.253:30303?discport=22874,enode://5e74f9b187dc0ce2d242a212252a4f22360c2cc6cb4c7911b09756d7b7e0a092773d580d216a7f0c8cbbb35631a04635d862595c61997f407bee7b3f7f0b3b39@40.76.116.159:30303,enode://9c40cff572d14caa2ccfa1c37fdcb2e2019b54e9cfec8fb17dcaadf8665158c64bd419204f1bbc2fde0313bbeb9bafd24a86f70659f284f012b2236ecfe9347d@136.243.39.40:30301,enode://87a32fd13bd596b2ffca97020e31aef4ddcc1bbd4b95bb633d16c1329f654f34049ed240a36b449fda5e5225d70fe40bc667f53c304b71f8e68fc9d448690b51@3.231.138.188:30301,enode://ca21ea8f176adb2e229ce2d700830c844af0ea941a1d8152a9513b966fe525e809c3a6c73a2c18a12b74ed6ec4380edf91662778fe0b79f6a591236e49e176f9@184.72.129.189:30301,enode://acf4507a211ba7c1e52cdf4eef62cdc3c32e7c9c47998954f7ba024026f9a6b2150cd3f0b734d9c78e507ab70d59ba61dfe5c45e1078c7ad0775fb251d7735a2@3.220.145.177:30301,enode://8a5a5006159bf079d06a04e5eceab2a1ce6e0f721875b2a9c96905336219dbe14203d38f70f3754686a6324f786c2f9852d8c0dd3adac2d080f4db35efc678c5@3.231.11.52:30301,enode://cdadbe835308ad3557f9a1de8db411da1a260a98f8421d62da90e71da66e55e98aaa8e90aa7ce01b408a54e4bd2253d701218081ded3dbe5efbbc7b41d7cef79@54.198.153.150:30301" \
    --rollup.disabletxpoolgossip=true \
    $ADDITIONAL_ARGS # intentionally unquoted
