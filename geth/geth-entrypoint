#!/bin/bash
set -eu

VERBOSITY=${GETH_VERBOSITY:-3}
GETH_DATA_DIR=/data
RPC_PORT="${RPC_PORT:-8545}"
WS_PORT="${WS_PORT:-8546}"
AUTHRPC_PORT="${AUTHRPC_PORT:-8551}"
METRICS_PORT="${METRICS_PORT:-6060}"
#HOST_IP="" # put your external IP address here and open port 30303 to improve peer connectivity
P2P_PORT="${P2P_PORT:-30303}"
ADDITIONAL_ARGS=""
OP_GETH_GCMODE="${OP_GETH_GCMODE:-full}"
OP_GETH_SYNCMODE="${OP_GETH_SYNCMODE:-snap}"

# Add cache and txpool optimizations with defaults
GETH_CACHE="${GETH_CACHE:-20480}"
GETH_CACHE_DATABASE="${GETH_CACHE_DATABASE:-20}"
GETH_CACHE_GC="${GETH_CACHE_GC:-12}"
GETH_CACHE_SNAPSHOT="${GETH_CACHE_SNAPSHOT:-24}"
GETH_CACHE_TRIE="${GETH_CACHE_TRIE:-44}"

if [[ -z "$OP_NODE_NETWORK" ]]; then
    echo "expected OP_NODE_NETWORK to be set" 1>&2
    exit 1
fi

mkdir -p $GETH_DATA_DIR

echo "$OP_NODE_L2_ENGINE_AUTH_RAW" > "$OP_NODE_L2_ENGINE_AUTH"

if [ "${OP_GETH_ETH_STATS+x}" = x ]; then
    ADDITIONAL_ARGS="$ADDITIONAL_ARGS --ethstats=$OP_GETH_ETH_STATS"
fi

if [ "${OP_GETH_ALLOW_UNPROTECTED_TXS+x}" = x ]; then
    ADDITIONAL_ARGS="$ADDITIONAL_ARGS --rpc.allow-unprotected-txs=$OP_GETH_ALLOW_UNPROTECTED_TXS"
fi

if [ "${OP_GETH_STATE_SCHEME+x}" = x ]; then
    ADDITIONAL_ARGS="$ADDITIONAL_ARGS --state.scheme=$OP_GETH_STATE_SCHEME"
fi

if [ "${OP_GETH_BOOTNODES+x}" = x ]; then
    ADDITIONAL_ARGS="$ADDITIONAL_ARGS --bootnodes=$OP_GETH_BOOTNODES"
fi

#if [ "${HOST_IP:+x}" = x ]; then
#	ADDITIONAL_ARGS="$ADDITIONAL_ARGS --nat=extip:$HOST_IP"
#fi

exec ./geth \
    --datadir="$GETH_DATA_DIR" \
    --verbosity="$VERBOSITY" \
    --db.engine=pebble \
    --state.scheme=path \
    --history.transactions=23500 \
    --history.state=2000 \
    --cache=12288 \
    --http \
    --http.corsdomain="*" \
    --http.vhosts="*" \
    --http.addr=0.0.0.0 \
    --http.port="$RPC_PORT" \
    --http.api=web3,debug,eth,txpool,net,engine \
    --authrpc.addr=0.0.0.0 \
    --authrpc.port="$AUTHRPC_PORT" \
    --authrpc.vhosts="*" \
    --authrpc.jwtsecret="$OP_NODE_L2_ENGINE_AUTH" \
    --ws \
    --ws.addr=0.0.0.0 \
    --ws.port="$WS_PORT" \
    --ws.origins="*" \
    --ws.api=web3,eth,txpool,net,engine \
    --metrics \
    --metrics.addr=0.0.0.0 \
    --metrics.port="$METRICS_PORT" \
    --syncmode="$OP_GETH_SYNCMODE" \
    --gcmode="$OP_GETH_GCMODE" \
    --maxpeers=100 \
    --rollup.sequencerhttp="$OP_GETH_SEQUENCER_HTTP" \
    --rollup.halt=major \
    --op-network="$OP_NODE_NETWORK" \
    --port="$P2P_PORT" \
    --bootnodes "enode://e5a61ec4be3d8383dd9932523a323e5e100f271958c6c0d416d96ec035fd41314834e9dbfa125e7ba13289af9de5eff2d79271e1120e3df47a0deece5f170b5a@130.61.106.250:30303,enode://2f0ca0ceb8b547696d23e9dbe058095563bd4d7f7cc4c5e98e5c7c07a791e87d59daea983ef7ce1b9e65709d187e0126d38ddd91256ab67801c827be863c34db@95.217.120.236:30303,enode://0485069ac65159e4b0d7fb8fbf53c9b71ce28bd2e07615ffb6764e9c761760c971f0577409c8a0e126b37be21b0673e496a85e9a1b88b3e935abb777650264f8@50.18.87.49:30303,enode://5e74f9b187dc0ce2d242a212252a4f22360c2cc6cb4c7911b09756d7b7e0a092773d580d216a7f0c8cbbb35631a04635d862595c61997f407bee7b3f7f0b3b39@15.204.222.130:30303,enode://9c40cff572d14caa2ccfa1c37fdcb2e2019b54e9cfec8fb17dcaadf8665158c64bd419204f1bbc2fde0313bbeb9bafd24a86f70659f284f012b2236ecfe9347d@162.220.162.182:40303,enode://37c5fa88197b38890f2d50f45b29c6d55fa68ab2edd08020dbc7d4d52887bc375418074946fd8cd70534220d32ca4dca7e6b19d0108d5fbbdd70bda017528765@34.32.238.165:30303?discport=30301,enode://17ea82762203ba12d25d3fc3a23895838aa1d9bde006ce43d0cabf5759c6ef2812ec6565070b8fc2cc9f8833b09eb82f8bea6c69017273d0f475abba69aca575@54.153.65.222:30303,enode://7471b355f0cff27341c0c5f9100950612b4bf8cf48f50758bc3eb35778bf2f8a94c6ae52feaa3d765c643448a944f9f3075c711fff0f8657123cb95bfb011bfd@138.2.91.177:30303?discport=9000,enode://7240226909f90f292c47383daaca4b517ced5e05753f0b9aca847804f5dd51e874596c9693ac5c2f0c524d6c0db45cc7f60fdff7d1dea95634dea9be373dcc84@65.108.131.176:30304?discport=9999,enode://4ef9300219935d1ed766073300541ad925eca9e01177f0d21fd9265103b8bf90bf976884df19d8df0b667b889de16751c163f4aa3db1e1f441ac9bfac6335ce7@67.209.55.23:13503,enode://e04c319e4713149d8f9bc0741b3ab8f4b1ef076c06938bfbfb328adc61d35fd6e59598a3d699e9e65b338b45f4f91bc836a8183cb522af489e06f713f8e12887@162.55.14.47:40303,enode://5e74f9b187dc0ce2d242a212252a4f22360c2cc6cb4c7911b09756d7b7e0a092773d580d216a7f0c8cbbb35631a04635d862595c61997f407bee7b3f7f0b3b39@15.204.222.129:30303,enode://ce6186adc63983acc9557755fe73eaa18e5eaed68ebe13972a9acf1ece166d2eb3b5c72af5411ea04a0b825e50939dc571c603e4301a08f6ccb289fde36257ff@18.195.171.175:30304?discport=30303,enode://c144953c63fc1325c0c84b1b90489dc2640e26acc6863fdaa5b0ca5898877e874e51e5df8e2921b08a8c095b7283213f72178bf8a79be254e5fc67e98d31fd70@117.27.228.173:31003,enode://3cfe0d21fc672374371d295897b0747f6706c02b7131f2513c8deb0c27623fa8dce9c238d760dc7b43d259aa906fb2e5da9f6841be801ee263da0197ca7b4c72@141.148.66.135:30303,enode://aa6b93472ce23df69128b8459ab6007c449a518f32870028a0d47c0f6a430a808363036c1bd2cb142a5868a2a8e1ddbd0a24896d6d6cceab9267fd8449aa65a5@65.21.65.246:30303,enode://6cc99f4e5bf3b7261f909d34bb7d0f08f247f7b5f8958ad3aed636f9f3fc43c29b5e12c57068b9f3fe57b8004c6c89deef496fd829b5b28b4956cb2752a8e3a8@162.55.75.187:30303,enode://14d0dbb9608d60e751cf83ad57085f5dfc3556de58ee2aee7f5092ff164a9b5f90bf8be3f87ff250a06ace7e5ff6268c51ea5e4cc563e794fe53987997e41722@173.231.41.130:30306,enode://fa27da5e515ee07ec6a4170d986ad68aa212d4bf129ddfdfce3da521500ace7e9b9bdde939ec9431405f6a20a3354722e860675224f36a555a865a9bfc0af4bc@204.16.247.253:30303?discport=22874,enode://5e74f9b187dc0ce2d242a212252a4f22360c2cc6cb4c7911b09756d7b7e0a092773d580d216a7f0c8cbbb35631a04635d862595c61997f407bee7b3f7f0b3b39@40.76.116.159:30303,enode://9c40cff572d14caa2ccfa1c37fdcb2e2019b54e9cfec8fb17dcaadf8665158c64bd419204f1bbc2fde0313bbeb9bafd24a86f70659f284f012b2236ecfe9347d@136.243.39.40:30301,enode://87a32fd13bd596b2ffca97020e31aef4ddcc1bbd4b95bb633d16c1329f654f34049ed240a36b449fda5e5225d70fe40bc667f53c304b71f8e68fc9d448690b51@3.231.138.188:30301,enode://ca21ea8f176adb2e229ce2d700830c844af0ea941a1d8152a9513b966fe525e809c3a6c73a2c18a12b74ed6ec4380edf91662778fe0b79f6a591236e49e176f9@184.72.129.189:30301,enode://acf4507a211ba7c1e52cdf4eef62cdc3c32e7c9c47998954f7ba024026f9a6b2150cd3f0b734d9c78e507ab70d59ba61dfe5c45e1078c7ad0775fb251d7735a2@3.220.145.177:30301,enode://8a5a5006159bf079d06a04e5eceab2a1ce6e0f721875b2a9c96905336219dbe14203d38f70f3754686a6324f786c2f9852d8c0dd3adac2d080f4db35efc678c5@3.231.11.52:30301,enode://cdadbe835308ad3557f9a1de8db411da1a260a98f8421d62da90e71da66e55e98aaa8e90aa7ce01b408a54e4bd2253d701218081ded3dbe5efbbc7b41d7cef79@54.198.153.150:30301,enode://8b3a55625312f78c199d47ec293f7a40346f53bf0e68a3a489847f7a1885334876afdaf9bd91d34486abe0e9e04a167dd34d04941d108f332a4882c9776714c2@208.115.223.155:30303,enode://ee4d23f71469c6af88335615f4f7bbb5891454ea5f2c8056dbc381c2c197a3bd41843057e0e2b519f1dfa48ac03d1c027fe2c4d46028b0cf6dc2bf43cc138ca0@38.18.230.153:14759?discport=9200,enode://291051b95976b1bc42d6fe11c3d499a06f61efb895618f73ec30e48be8424c0f877190ee98e7ebccef17f68512e6b5b74a3b461424a2ae0dedaa4380c3ba1c0f@5.9.23.249:30303?discport=30301,enode://100270513345f8db1b151d88edeb06a904738468d548a107532daf2c5929c4faef49abc6c82fd19f2824c2512e29192897954b12677f4a006126bad1fdb20d3c@15.235.226.28:20303,enode://f3ba8b260d4203a2fbf83b0446251bd04e253d34ead822cc2f2ecee2d3d8fc7b2c8bd00fe090ab50e6589a7cf72cfdbe289b9d96e1bb0763cd5a559815101397@65.21.45.43:30303,enode://acffbb5ee37da10433c651779505b978873d64fb0b2adc19c4f2920e92919eba901fb47a500d159d1c097e8038536a60a7a225c255d7270bc691d1b77188be8a@142.132.161.118:30303,enode://ff8b59a1a245d31a45ac383431f44112762a55090d8f81c1ab5cdf4d1f23af0d99667c9e879d030511a02555e544a476ef895afc9d86ae6c1b75523d7054621e@65.108.204.142:30303,enode://1f602afca94b2456deecb5fb9ce827162f627083016317d1f4865b516aee633e42b56faf28005c59b9711e98b495e34c04bb0a15c79ee0e6680df68f08a69176@124.243.140.11:30303,enode://f0db0820a881d20aaab6316da67727e4c7f6f5161268449f3ee4a16bdc3ac014f47846ef4052dc3120d921edeec64b92f1d3a86c5a4f098ddfaa437bab6edfab@40.160.27.37:30303?discport=9200,enode://24cc0a1f6fa0f9fe59e2c878d6c8892446cead0bcbb27f64a96694026eebfdb38e0de5d7a240bd4ae55ff227a6a645cc6d7a26807552793ad4cc911e2ad53306@147.28.185.162:30303?discport=22386,enode://e96181e1eec63362e355777d325d0be3f6f169084dab2a30da166f3a51f991942f0a892bd360b69999329eb508c790cd762b6f9654689965781bc2b305955c56@173.231.41.114:30305?discport=30306,enode://85e34433dcad66fa4c587562d8342b027bb09a48da01aec64d69ae1f844342ba11dca7c69464cda6b40958fdccb385ff1938fd0605d6de8a1d5af436b2cd2107@15.204.222.129:30303,enode://e5cc4c82d0995a73c9b31ba298728b203c71051629480c8e7cf433b06210fd878e72f3298baa0b6e4b0f564148764efbea2fb2eb9f8c13eace5c82d2ae31c081@208.115.201.22:30303,enode://b34f2a2606827d0eaa06f95e10540950f65c32d55cafdcee705f6b089870436278febc969ce1cba9724c121a05d198213d667d8953cefa5362bab843c526c6bf@23.88.2.34:30303?discport=6709,enode://144ca69a37b14c6e3ce446516e1d3dbbd64fe46188a89446a667877ecd4d4a63cfa3a4bcded852a670c6bcb38a857fe2d91f57704ab05b61022192144a891753@135.181.165.222:30303,enode://6b096c690e12e1b83eec4cf22c072be381cd4d1d7653e262973170e28913221098f1efcdb71c4bd43a048f0a4714f1397c2f008341efc8ed7390438b44d7020d@169.155.170.250:30303,enode://daf18d02b87d8b8a24c4ec4a7b47142ce1384560848c32fba458742e9f8b80d1ebaf10998a62d17600dd8ad6975f4471af60973668992b64fb74ad4cc37ccd2e@45.59.171.176:30306,enode://a3c2f115d7b67e1826916076071648922d769f575c9bb8fdb3bab7e01e40a9ca45b86c435a302728600a0e548785bfad6e68d8f50fb702a593ba9609f675e794@185.172.184.26:31001?discport=9200,enode://839e91818a3ee280c25b2fd5ee6ccb88694e43690da34a845da970ac97628a2846361deee148b89773439ad9b5f87794604c53cec2d7f9cfd051c85ab671133d@148.251.137.158:30403,enode://388bcb6262cf7e95f61830e3dc7a2bb8304ad8488450417f8817217db715ace6da83e447689c1667bf4e3a1eb2c5af7b105e0fad426efe7d1012ff026d92076e@208.115.248.226:30303,enode://3b0052b031fdfca877501f8dc12ecf3a003a01e62a19dc99f220786ddb0cdcdafe9b598114808235807979654a86061461ed8aebc8673d2eabf39bc96dcadf38@65.108.104.47:30303,enode://e738a1bea3fc622f8b783fdc58b491e96c77b819db535656dfcd0dd4af78ce0b7a97607f12c8fdd4cfcfa79d80357daaa6366307e3a9158bf038a11df721566b@38.248.91.137:30303,enode://b8ff7fef703a92afe67e0d0ae94182f2fb274f680cdc4f652f83c940dc4b52c954b7fadf84f12c84b43cc1449ed5c0d33e05f7c4558a9b9dd428982bfe958cf8@176.9.103.116:30303,enode://6cc86b9d1e6b84617f9d594e01f3499580c75b175627e9549abd470d645090999e43777ffe26b8c6ae7c096262423ac02dcf913e05dcfd7f0f72a3571f090638@18.136.197.239:30303?discport=9200,enode://2a80ec753a1fcf46d9de7cda9292b4e095bcf33e68a54925de98699e2bff4974ad24c9e882cf7bde6a8e5b3ef4e75179252bef2b577f8f9ac98bd3e5354eeff9@116.202.32.156:30303,enode://103ded5f824a1718e8d97fa4a91bb88cfaa88500c7485af5940daf44b3bc58e4d84daa3e48b122dd3cc5fffd6116c33ea1d57d418b4c9457f8596963b79d7d26@40.160.22.140:30303,enode://6ed0d6747fe47ab141b0eb0d67eec51917a03bf025af54035c4e6d22ec835f8127b1be9e646bdd3468cf74d77efb1441d943850ad2727674b746c102054a941b@136.243.24.53:30303?discport=9640,enode://9f31e0e2e9514ba6208b5592870cca23ad5140c498afad55ed4d396b33f7b160b886df12cc4317ef2d223765f0c0ed3f40cbc00df61ae9a22f2be51e61595f7f@91.237.141.187:30303,enode://bfdf8cfcb2dc9fd334c61d36297a83a9170900698de43a82d320ea6963b93ec4e53be122e95b30399ad7e1fe85ed123458af6fa4dd6dfac563fb14e4574382b0@5.9.50.209:30304?discport=9200,enode://2ab9a051776a1e26e6f41b67d6841093b574b06bb29bdaee5a4983db0123398e4a7d794513105e12d91234b7f79fd749a61be51df0b201765e70655402517c76@92.204.174.51:30303,enode://0c586dd2513c407d46cbf87288b1a9e07914ba15a5dc701af9f40874d4a64b1dd29b6260cb02814a1fba1b9274052855732ee8659cce5058ee16f440377470a7@52.74.237.214:30303?discport=45172,enode://abe88facf8ca9420da2fa155c9ffa60660319f63447c498dba09257c8cba24431b5494f0f6857fecdb3fa4b9559bfc39b237215efc09d210e96bfebc7d1e09b4@173.231.45.114:30307?discport=30308,enode://3fe3bb7f8446a2b391f07133767471ace06d3cc1f2e0e669c308088c64d0c733d1d67a2bd42dbda96b2ba711a25485cffa1fb9c662adc6be4efd5b28bd18f667@162.55.234.31:30303?discport=59947" \
    --rollup.disabletxpoolgossip=true \
    --cache="$GETH_CACHE" \
    --cache.database="$GETH_CACHE_DATABASE" \
    --cache.gc="$GETH_CACHE_GC" \
    --cache.snapshot="$GETH_CACHE_SNAPSHOT" \
    --cache.trie="$GETH_CACHE_TRIE" \
    $ADDITIONAL_ARGS # intentionally unquoted